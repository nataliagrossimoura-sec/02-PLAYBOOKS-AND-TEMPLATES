# ü¶† PLAYBOOK: Conten√ß√£o e Resposta a Malware

## üìã Informa√ß√µes do Documento

| Campo | Valor |
|-------|-------|
| **Vers√£o** | 1.0 |
| **Data de Cria√ß√£o** | Dezembro 2025 |
| **√öltima Revis√£o** | Dezembro 2025 |
| **Propriet√°rio** | Equipe SOC |
| **Classifica√ß√£o** | Interno - Confidencial |

---

## üéØ Objetivo

Procedimento padronizado para detec√ß√£o, conten√ß√£o, erradica√ß√£o e recupera√ß√£o de infec√ß√µes por malware, incluindo ransomware, trojans, worms e backdoors.

---

## üìä Escopo

### Tipos de Malware Cobertos

| Tipo | Descri√ß√£o | Severidade T√≠pica |
|------|-----------|-------------------|
| **Ransomware** | Criptografa arquivos, exige resgate | üî¥ Cr√≠tica |
| **Trojan** | Backdoor, controle remoto | üü† Alta |
| **Worm** | Auto-propaga√ß√£o, sem intera√ß√£o | üü† Alta |
| **Spyware** | Roubo de informa√ß√µes | üü° M√©dia-Alta |
| **Adware** | Propaganda, menos destrutivo | üü¢ Baixa-M√©dia |
| **Rootkit** | Esconde presen√ßa, persist√™ncia | üî¥ Cr√≠tica |
| **Keylogger** | Captura digita√ß√£o | üü° M√©dia |
| **Cryptominer** | Minera criptomoeda, degrada performance | üü° M√©dia |

---

## üë• Pap√©is e Responsabilidades

| Papel | Responsabilidade | SLA |
|-------|------------------|-----|
| **First Responder** | Isolamento inicial, preserva√ß√£o | 5 min |
| **Malware Analyst** | An√°lise t√©cnica, identifica√ß√£o | 30 min |
| **System Admin** | Acesso sistemas, remedia√ß√£o | 15 min |
| **Backup Admin** | Restaura√ß√£o de dados | 1 hora |
| **Communications** | Updates stakeholders, usu√°rios | 2 horas |
| **Legal/Compliance** | Notifica√ß√µes obrigat√≥rias (se dados expostos) | 24 horas |

---

## üö® Matriz de Severidade

| N√≠vel | Crit√©rios | A√ß√£o Imediata | Escala√ß√£o |
|-------|-----------|---------------|-----------|
| **P0 - Emerg√™ncia** | Ransomware ativo, Propaga√ß√£o r√°pida, Sistema cr√≠tico | ISOLAR IMEDIATAMENTE | CEO + CISO |
| **P1 - Cr√≠tico** | Servidor comprometido, Dados sens√≠veis em risco | Conten√ß√£o em 15 min | CISO |
| **P2 - Alto** | Workstation comprometido, Malware conhecido | Conten√ß√£o em 30 min | Manager |
| **P3 - M√©dio** | Malware detectado e bloqueado | Investiga√ß√£o em 2h | Lead |
| **P4 - Baixo** | Falso positivo prov√°vel | Valida√ß√£o em 4h | Analista |

---

## üîÑ FLUXO DE RESPOSTA

```
Detec√ß√£o ‚Üí Isolamento Imediato ‚Üí An√°lise ‚Üí Conten√ß√£o ‚Üí 
Erradica√ß√£o ‚Üí Recupera√ß√£o ‚Üí Post-Mortem
```

---

## üìç FASE 1: DETEC√á√ÉO (0-5 min)

### Indicadores de Infec√ß√£o

**Sintomas Comuns:**
```
üö© Performance lenta repentina
üö© Arquivos criptografados / extens√µes estranhas
üö© Tela de resgate (ransom note)
üö© Processos desconhecidos alto CPU/mem√≥ria
üö© Conex√µes de rede para IPs desconhecidos
üö© Arquivos criados/modificados sem a√ß√£o do usu√°rio
üö© Antiv√≠rus desabilitado
üö© Comportamento an√¥malo (popups, tela travada)
```

**Fontes de Detec√ß√£o:**
- EDR/Antiv√≠rus alert
- SIEM correlation rule
- Reporte de usu√°rio
- Monitoramento de rede
- Scan programado

### Verifica√ß√£o R√°pida

**Usu√°rio Final (se poss√≠vel):**
```
1. N√ÉO DESLIGAR o computador
2. N√ÉO interagir mais (n√£o abrir arquivos)
3. Tirar foto da tela
4. Desconectar da rede:
   - WiFi: Desligar WiFi
   - Cabo: Desplugue cabo de rede
5. Notificar TI/Seguran√ßa IMEDIATAMENTE
```

**Analista SOC:**
```bash
# Verificar processo suspeito
ps aux | grep -i <processo_suspeito>
Get-Process | Where-Object {$_.Name -like "*suspeito*"}

# Verificar conex√µes
netstat -antp | grep ESTABLISHED
Get-NetTCPConnection | Where-Object {$_.State -eq "Established"}

# Verificar arquivos recentemente modificados
find / -type f -mmin -60  # √∫ltimos 60 min
Get-ChildItem -Recurse | Where-Object {$_.LastWriteTime -gt (Get-Date).AddHours(-1)}
```

---

## üìç FASE 2: ISOLAMENTO IMEDIATO (5-15 min)

### ‚ö° A√á√ÉO CR√çTICA: PARAR PROPAGA√á√ÉO

**Prioridade 1: Isolamento de Rede**

```bash
# M√âTODO 1: F√≠sico (Prefer√≠vel)
# Desplugue cabo de rede OU desative WiFi

# M√âTODO 2: Firewall local (se remoto)
# Linux
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP

# Windows
New-NetFirewallRule -DisplayName "Block All" -Direction Outbound -Action Block
New-NetFirewallRule -DisplayName "Block All" -Direction Inbound -Action Block

# M√âTODO 3: N√≠vel de switch (se poss√≠vel)
# Desabilitar porta no switch
```

**‚ö†Ô∏è EXCE√á√ÉO - N√ÉO ISOLAR Se:**
- Coordenado com law enforcement (investiga√ß√£o ativa)
- Necess√°rio observar comportamento (decis√£o do Lead)
- Honeypot intencional

**Prioridade 2: Conter Lateralmente**

```
[ ] Identificar segmento de rede do sistema infectado
[ ] Implementar ACLs tempor√°rias limitando acesso desse segmento
[ ] Alertar SysAdmins de sistemas adjacentes
[ ] Monitorar tr√°fego para detectar propaga√ß√£o
```

### Preserva√ß√£o de Evid√™ncias

**ANTES de qualquer a√ß√£o destrutiva:**

```bash
# 1. Capturar mem√≥ria (RAM)
# Linux
sudo insmod lime.ko "path=/evidence/memory-$(hostname)-$(date +%Y%m%d-%H%M).lime format=lime"

# Windows
DumpIt.exe /OUTPUT E:\evidence\memory-$(hostname)-$(date).dmp

# 2. Listar processos em execu√ß√£o
# Linux
ps auxf > /evidence/processes-$(date +%Y%m%d-%H%M).txt

# Windows
Get-Process | Export-Csv E:\evidence\processes.csv

# 3. Listar conex√µes de rede
netstat -antp > /evidence/netstat.txt  # Linux
netstat -ano > E:\evidence\netstat.txt  # Windows

# 4. Snapshot de VM (se aplic√°vel)
# VirtualBox
VBoxManage snapshot "<VM-Name>" take "MALWARE-INFECTION-$(date +%Y%m%d-%H%M)"

# 5. Calcular hashes de arquivos suspeitos
find /tmp -type f -exec sha256sum {} \; > /evidence/hashes.txt
```

---

## üìç FASE 3: AN√ÅLISE (15-60 min)

### 3.1 Identifica√ß√£o do Malware

**A) An√°lise de Arquivo**

```bash
# Obter hash do arquivo suspeito
sha256sum malware.exe
md5sum malware.exe

# Verificar em VirusTotal (submeta hash, N√ÉO arquivo completo)
curl "https://www.virustotal.com/api/v3/files/$(sha256sum malware.exe | cut -d' ' -f1)" \
  -H "x-apikey: YOUR_API_KEY"

# Informa√ß√µes b√°sicas (N√ÉO EXECUTE)
file malware.exe
strings malware.exe | less
exiftool malware.exe
```

**B) Identificar Fam√≠lia de Malware**

**Ransom Note Detection:**
```bash
# Procurar por arquivos de resgate comuns
find / -name "*README*.txt" -o -name "*DECRYPT*.txt" -o -name "*HOW_TO*"
find / -name "*.hta" -o -name "*.html" 2>/dev/null | xargs grep -l "bitcoin\|ransom\|decrypt"

# Conte√∫do t√≠pico:
# "Your files have been encrypted"
# "Send Bitcoin to..."
# "Deadline to pay"
```

**Identificar Variante:**
```
Extens√µes de arquivos criptografados:
.locked ‚Üí LockBit
.encrypted ‚Üí Various
.crypted ‚Üí CryptoLocker
.wannacry ‚Üí WannaCry
.ryuk ‚Üí Ryuk
.maze ‚Üí Maze
```

**C) An√°lise de Comportamento**

```bash
# Comandos executados recentemente
# Linux
history
cat ~/.bash_history

# Windows
Get-History
Get-Content (Get-PSReadlineOption).HistorySavePath

# Tarefas agendadas criadas
# Linux
crontab -l
ls -la /etc/cron.*

# Windows
schtasks /query /fo LIST /v

# Servi√ßos criados/modificados
systemctl list-units --type=service --state=running  # Linux
Get-Service | Where-Object {$_.Status -eq "Running"}  # Windows

# Chaves de registro (Windows)
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
```

### 3.2 Determinar Vetor de Entrada

**Poss√≠veis Vetores:**
```
[ ] Email phishing (anexo)
[ ] Download drive-by (site comprometido)
[ ] Exploit de vulnerabilidade
[ ] M√≠dia remov√≠vel (USB)
[ ] RDP exposto
[ ] Credenciais fracas/compartilhadas
[ ] Software pirata
[ ] Supply chain (update malicioso)
```

**Investigar:**
```bash
# Logs de autentica√ß√£o
# Linux
grep -i "accepted password" /var/log/auth.log | tail -50

# Windows
Get-WinEvent -FilterHashtable @{LogName='Security';ID=4624} | Select-Object -First 50

# Downloads recentes
# Linux
ls -lht ~/Downloads/ | head -20

# Windows
Get-ChildItem $env:USERPROFILE\Downloads -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 20
```

### 3.3 Escopo da Infec√ß√£o

**Responder:**
```
‚ùì Apenas 1 sistema ou m√∫ltiplos?
‚ùì Usu√°rio comum ou conta privilegiada?
‚ùì Workstation ou servidor?
‚ùì Dados locais ou rede/nuvem?
‚ùì Propaga√ß√£o lateral j√° ocorreu?
‚ùì Quanto tempo desde infec√ß√£o inicial?
```

---

## üìç FASE 4: CONTEN√á√ÉO COMPLETA (1-4 horas)

### 4.1 Decis√£o: Limpar ou Reimagear?

**REIMAGEAR (Recomendado para):**
```
‚úÖ Ransomware
‚úÖ Rootkit
‚úÖ Infec√ß√£o antiga (days/weeks)
‚úÖ M√∫ltiplos malwares
‚úÖ Incerteza se est√° completamente limpo
‚úÖ Sistema cr√≠tico
```

**LIMPAR (Aceit√°vel para):**
```
‚ö†Ô∏è Malware simples conhecido
‚ö†Ô∏è Infec√ß√£o muito recente (minutes)
‚ö†Ô∏è Sistema de desenvolvimento/teste
‚ö†Ô∏è EDR confirma remo√ß√£o completa
‚ö†Ô∏è Budget/tempo cr√≠ticos
```

### 4.2 Conter Dados

**Se Ransomware:**
```
[ ] N√ÉO PAGAR resgate (regra geral)
[ ] Identificar √∫ltimo backup bom
[ ] Isolar backups para prevenir criptografia
[ ] Verificar se backups est√£o limpos
[ ] Considerar recupera√ß√£o de shadow copies (se n√£o deletadas)
```

**Shadow Copy Recovery (Windows):**
```powershell
# Listar shadow copies dispon√≠veis
vssadmin list shadows

# Recuperar arquivo espec√≠fico
# (executar de sistema limpo, montando disco infectado)
```

**Se Exfiltra√ß√£o:**
```
[ ] Identificar quais dados foram acessados
[ ] Verificar uploads/transfer√™ncias (logs proxy/firewall)
[ ] Determinar se encripta√ß√£o em tr√¢nsito ocorreu
[ ] Preparar notifica√ß√µes (LGPD/GDPR se aplic√°vel)
```

### 4.3 Conter Propaga√ß√£o

**Em Rede:**
```bash
# Bloquear C2 domains/IPs
# pfSense / Firewall
echo "<IP_C2>" >> /etc/pf-blocklist.txt
pfctl -t blocklist -T add <IP_C2>

# Bloquear em TODOS sistemas
# Ansible playbook
ansible all -m shell -a "iptables -A OUTPUT -d <IP_C2> -j DROP"
```

**Em Active Directory:**
```powershell
# Se comprometimento de dom√≠nio suspeito
# Resetar senha de todos usu√°rios (last resort)
Get-ADUser -Filter * | Set-ADAccountPassword -Reset

# Desabilitar contas de servi√ßo suspeitas
Disable-ADAccount -Identity "svc_suspicious"

# For√ßar re-autentica√ß√£o
Get-ADComputer -Filter * | Set-ADComputer -PasswordNeverExpires $false
```

---

## üìç FASE 5: ERRADICA√á√ÉO (4-24 horas)

### 5.1 Remo√ß√£o Completa

**Op√ß√£o A: Reimagem (Recomendado)**

```bash
# 1. Backup de dados do usu√°rio (verificar que est√£o limpos)
rsync -avz /home/user/Documents /backup/clean-data/

# 2. Wipe completo do disco
# CUIDADO: Isto DELETA TUDO
dd if=/dev/zero of=/dev/sda bs=1M status=progress

# 3. Reinstalar SO
# Boot de m√≠dia de instala√ß√£o
# Instalar vers√£o atualizada

# 4. Aplicar TODOS patches de seguran√ßa
apt update && apt upgrade -y  # Linux
# Windows Update at√© n√£o haver mais

# 5. Reinstalar aplica√ß√µes
# Usar m√©todos automatizados (Ansible, MDM)

# 6. Restaurar dados verificadamente limpos
rsync -avz /backup/clean-data/ /home/user/Documents
```

**Op√ß√£o B: Limpeza Manual (Menos Confi√°vel)**

```bash
# 1. Boot em modo de recupera√ß√£o / LiveCD
# N√ÉO boot no SO infectado

# 2. Montar sistema de arquivos
mount /dev/sda1 /mnt/infected

# 3. Remover malware conhecido
rm -f /mnt/infected/path/to/malware.exe

# 4. Remover persist√™ncia
# Crontabs
rm /mnt/infected/etc/cron.d/malicious-job

# Startup scripts
rm /mnt/infected/etc/rc.local.d/malware-start

# Services
rm /mnt/infected/etc/systemd/system/malware.service

# 5. Scan completo de antiv√≠rus
clamscan -r --remove /mnt/infected

# 6. Verificar sistema de arquivos
fsck /dev/sda1
```

### 5.2 Corre√ß√£o de Vulnerabilidades

**Identificar Como Malware Entrou:**
```
[ ] Patch de software vulner√°vel
[ ] Atualizar antiv√≠rus/EDR
[ ] Configurar firewall mais restritivo
[ ] Desabilitar servi√ßos desnecess√°rios (SMB, RDP)
[ ] Implementar whitelisting de aplica√ß√µes
[ ] Enfor√ßar MFA
[ ] Treinar usu√°rios (se phishing)
```

**Hardening P√≥s-Infec√ß√£o:**
```powershell
# Windows
# Desabilitar SMBv1
Disable-WindowsOptionalFeature -Online -FeatureName SMB1Protocol

# Habilitar Credential Guard
# Requires UEFI, Secure Boot
Enable-WindowsOptionalFeature -Online -FeatureName Credential-Guard

# Restringir PowerShell
Set-ExecutionPolicy AllSigned

# Linux
# Desabilitar servi√ßos desnecess√°rios
systemctl disable <service>

# Configurar SELinux
setenforce 1
sed -i 's/SELINUX=disabled/SELINUX=enforcing/' /etc/selinux/config

# AppArmor
aa-enforce /etc/apparmor.d/*
```

### 5.3 Valida√ß√£o de Limpeza

**Checklist de Verifica√ß√£o:**
```
[ ] Scan completo de antiv√≠rus (0 detec√ß√µes)
[ ] Scan de rootkit (chkrootkit, rkhunter)
[ ] Sem processos suspeitos
[ ] Sem conex√µes de rede an√¥malas
[ ] Sem tarefas agendadas desconhecidas
[ ] Sem servi√ßos suspeitos
[ ] Sem entradas de registro suspeitas (Windows)
[ ] Logs n√£o mostram atividade maliciosa
[ ] Performance voltou ao normal
```

**Ferramentas de Verifica√ß√£o:**
```bash
# Rootkit detection
# Linux
chkrootkit
rkhunter --check

# Windows
GMER
TDSSKiller

# IOC Scanner
yara -r rules/ /path/to/scan

# LOKI (IOC scanner)
python loki.py -p /path/to/scan
```

---

## üìç FASE 6: RECUPERA√á√ÉO (1-7 dias)

### 6.1 Restaura√ß√£o de Dados

**De Backups:**
```bash
# 1. Verificar integridade de backup
sha256sum /backup/data.tar.gz
# Comparar com hash conhecido

# 2. Scan de antiv√≠rus do backup
clamscan -r /backup/

# 3. Restaurar dados
tar -xzf /backup/data.tar.gz -C /restore/

# 4. Validar restaura√ß√£o
# Conferir arquivos cr√≠ticos
# Testar funcionalidade
```

**Se Backup Comprometido:**
```
[ ] Identificar √∫ltimo backup limpo
[ ] Aceitar perda de dados entre √∫ltimo backup limpo e infec√ß√£o
[ ] Documentar perda para relat√≥rio
[ ] Considerar recupera√ß√£o manual de dados cr√≠ticos
   (se skill t√©cnico e tempo permitirem)
```

### 6.2 Retorno √† Produ√ß√£o

**Abordagem Faseada:**
```
Dia 1: Sistema reconstru√≠do, testado em ambiente isolado
Dia 2: Retorno com monitoramento intensivo
Dia 3-7: Valida√ß√£o cont√≠nua, sem alertas
Dia 7: Normaliza√ß√£o completa
```

**Crit√©rios para Retorno:**
```
‚úì Sistema completamente limpo verificado
‚úì Vulnerabilidade corrigida
‚úì Backups testados e funcionais
‚úì Monitoramento refor√ßado implementado
‚úì Usu√°rio treinado (se aplic√°vel)
‚úì Stakeholders notificados
```

### 6.3 Monitoramento Intensivo P√≥s-Recupera√ß√£o

**30 Dias de Vigil√¢ncia:**
```
[ ] Scan de antiv√≠rus di√°rio
[ ] Revis√£o de logs di√°ria
[ ] Monitoramento de performance
[ ] Alertas para processos incomuns
[ ] Alertas para conex√µes de rede suspeitas
[ ] Revis√£o de arquivos criados/modificados
```

---

## üìç FASE 7: POST-MORTEM

### Li√ß√µes Aprendidas

**Responder:**
```
1. Como o malware entrou?
2. Por que n√£o foi detectado mais cedo?
3. O que funcionou bem na resposta?
4. O que pode ser melhorado?
5. Usu√°rio precisa de treinamento adicional?
6. Controles t√©cnicos precisam ser fortalecidos?
```

### Melhorias a Implementar

**T√©cnicas:**
```
[ ] Atualizar signatures de antiv√≠rus
[ ] Adicionar IOCs ao SIEM
[ ] Implementar whitelisting de aplica√ß√µes
[ ] Configurar EDR mais agressivo
[ ] Segmentar rede melhor
[ ] Implementar honeypots
```

**Processuais:**
```
[ ] Atualizar playbook com descobertas
[ ] Treinar equipe em nova fam√≠lia de malware
[ ] Revisar SLAs de resposta
[ ] Melhorar comunica√ß√£o com stakeholders
```

**Pessoas:**
```
[ ] Treinamento de awareness para usu√°rios
[ ] Simula√ß√£o de malware para equipe t√©cnica
[ ] Contratar/treinar especialista em malware
```

---

## ü¶† CASOS ESPECIAIS

### Ransomware

**Decis√£o de Pagar:**
```
‚ùå N√ÉO PAGAR (regra geral):
- Financia crime organizado
- Sem garantia de decryption
- Pode ser alvo futuro novamente
- Ilegal em algumas jurisdi√ß√µes

‚úÖ CONSIDERAR pagar (√∫ltima op√ß√£o):
- Dados absolutamente cr√≠ticos
- Sem backup
- Decryption key demonstrado funcional
- Neg√≥cio em risco existencial
- Ap√≥s consulta com Legal/Management
```

**Recursos:**
- [No More Ransom](https://www.nomoreransom.org/) - Decryptors gratuitos
- [ID Ransomware](https://id-ransomware.malwarehunterteam.com/) - Identificar variante

### Rootkit

**Detec√ß√£o:**
```bash
# Checar m√≥dulos do kernel carregados
lsmod | grep suspicious
dmesg | grep -i hidden

# Verificar syscalls hookeados
cat /proc/kallsyms | grep sys_call_table
```

**Remo√ß√£o:**
- Reimagem √â OBRIGAT√ìRIA
- Rootkit pode esconder arquivos/processos
- Imposs√≠vel confiar em sistema comprometido

### Cryptominer

**Identifica√ß√£o:**
```bash
# CPU usage anormal
top
htop

# Processos com nomes suspeitos
ps aux | grep -E 'xmrig|cpuminer|minerd'

# Conex√µes para pools de minera√ß√£o
netstat -antp | grep -E ':3333|:4444|:5555'
```

**Impacto:**
- Performance degradada
- Custos de energia
- Desgaste de hardware

---

## üìä IOCs Comuns

### Arquivos Suspeitos

```
C:\Users\Public\*
C:\ProgramData\*
%TEMP%\*.exe
%APPDATA%\Roaming\*.exe
/tmp/*.sh
/var/tmp/*.sh
```

### Processos Suspeitos

```
powershell.exe -encodedCommand
cmd.exe /c <longcommand>
wscript.exe <script.vbs>
mshta.exe http://
certutil -decode
bitsadmin /transfer
```

### Conex√µes de Rede Suspeitas

```
Conex√µes para IPs em pa√≠ses de risco
Conex√µes para dom√≠nios rec√©m-registrados
Beacons peri√≥dicos (C2 communication)
Tr√°fego DNS an√¥malo (tunneling)
```

---

## üõ†Ô∏è Ferramentas Recomendadas

### Detec√ß√£o
- **ClamAV** - Antiv√≠rus open source
- **Malwarebytes** - Anti-malware
- **YARA** - Pattern matching
- **LOKI** - IOC scanner

### An√°lise
- **VirusTotal** - Multi-engine scan
- **ANY.RUN** - Sandbox online
- **Joe Sandbox** - An√°lise automatizada
- **PEiD** - Detector de packers

### Forense
- **Volatility** - Memory forensics
- **Autopsy** - Disk analysis
- **FTK Imager** - Disk imaging
- **Wireshark** - Network analysis

### Remo√ß√£o
- **Malwarebytes** - Remo√ß√£o
- **HitmanPro** - Segundo opini√£o
- **Kaspersky Rescue Disk** - Boot clean
- **TDSS Killer** - Rootkit removal

---

## üìû Contatos de Emerg√™ncia

```
SOC Lead: [telefone]
CISO: [telefone]
Backup Admin: [telefone]
Vendor Support: [n√∫meros]
Law Enforcement (se necess√°rio): 197 (Brasil)
```

---

**ü¶† Lembre-se:** Malware evolui constantemente. Atualize este playbook regularmente com novas TTPs.

---

**√öltima atualiza√ß√£o:** Dezembro 2025  
**Vers√£o:** 1.0  
**Aprovado por:** CISO
